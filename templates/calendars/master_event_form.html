{% extends 'base.html' %}

{% block title %}{{ title }} - Calendar Builder{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header__main">
        <h1 class="page-title">{{ title }}</h1>
    </div>
    <div class="page-header__actions">
        <a href="{% url 'calendars:master_events' %}" class="btn btn--outline">Back to Events</a>
    </div>
</div>

<div class="form-container">
    <form method="post" enctype="multipart/form-data" class="form">
        {% csrf_token %}

        <div class="form-group">
            <label for="{{ form.name.id_for_label }}">Event/Person Name</label>
            {{ form.name }}
            {% if form.name.help_text %}
                <small class="form-help">{{ form.name.help_text }}</small>
            {% endif %}
            {% if form.name.errors %}
                <div class="form-errors">{{ form.name.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.event_type.id_for_label }}">Event Type</label>
            {{ form.event_type }}
            {% if form.event_type.help_text %}
                <small class="form-help">{{ form.event_type.help_text }}</small>
            {% endif %}
            {% if form.event_type.errors %}
                <div class="form-errors">{{ form.event_type.errors }}</div>
            {% endif %}
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="{{ form.month.id_for_label }}">Month</label>
                {{ form.month }}
                {% if form.month.errors %}
                    <div class="form-errors">{{ form.month.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.day.id_for_label }}">Day</label>
                {{ form.day }}
                {% if form.day.errors %}
                    <div class="form-errors">{{ form.day.errors }}</div>
                {% endif %}
            </div>
        </div>

        <div class="form-group">
            <label for="{{ form.year_occurred.id_for_label }}">Year (Optional)</label>
            {{ form.year_occurred }}
            {% if form.year_occurred.help_text %}
                <small class="form-help">For birthdays and anniversaries - the year it first occurred</small>
            {% endif %}
            {% if form.year_occurred.errors %}
                <div class="form-errors">{{ form.year_occurred.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.groups.id_for_label }}">Groups</label>
            {{ form.groups }}
            {% if form.groups.help_text %}
                <small class="form-help">Comma-separated list (e.g., "Family, Birthdays, Important")</small>
            {% endif %}
            {% if form.groups.errors %}
                <div class="form-errors">{{ form.groups.errors }}</div>
            {% endif %}
            {% if groups %}
                <div class="form-help">
                    <strong>Existing groups:</strong>
                    {% for group in groups %}
                        <span class="tag">{{ group.name }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.description.id_for_label }}">Description (Optional)</label>
            {{ form.description }}
            {% if form.description.errors %}
                <div class="form-errors">{{ form.description.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="master-event-image">Default Image (Optional)</label>
            <div class="master-event-photo-section">
                {% if form.instance.image %}
                    <div class="current-photo">
                        <img src="{{ form.instance.image.url }}" alt="{{ form.instance.name }}" class="master-event-photo">
                        <div class="photo-actions">
                            <form method="post" action="{% url 'calendars:master_event_upload_image' pk=form.instance.pk %}" enctype="multipart/form-data" class="inline-form">
                                {% csrf_token %}
                                <input type="file" name="image" accept="image/*" style="display: none;" id="changePhotoInput">
                                <label for="changePhotoInput" class="btn btn--secondary btn--small">
                                    ‚úèÔ∏è Change Photo
                                </label>
                            </form>
                            <form method="post" action="{% url 'calendars:master_event_remove_image' pk=form.instance.pk %}" class="inline-form" onsubmit="return confirm('Remove this photo?');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn--outline btn--small">
                                    ‚ùå Remove Photo
                                </button>
                            </form>
                        </div>
                    </div>
                {% else %}
                    <div class="no-photo">
                        <div class="no-photo-placeholder">
                            <span class="no-photo-icon">üì∑</span>
                            <span class="no-photo-text">No photo</span>
                        </div>
                        {% if form.instance.pk %}
                            <form method="post" action="{% url 'calendars:master_event_upload_image' pk=form.instance.pk %}" enctype="multipart/form-data" class="inline-form">
                                {% csrf_token %}
                                <input type="file" name="image" accept="image/*" style="display: none;" id="addPhotoInput">
                                <label for="addPhotoInput" class="btn btn--primary btn--small">
                                    ‚úèÔ∏è Add Photo
                                </label>
                            </form>
                        {% else %}
                            <p class="form-help">Save the event first to add a photo</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
            <small class="form-help">This image will be used as the default for all calendar events created from this master event</small>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn--primary">Save Event</button>
            <a href="{% url 'calendars:master_events' %}" class="btn btn--outline">Cancel</a>
        </div>
    </form>
</div>

<script>
// Auto-update form based on event type
document.addEventListener('DOMContentLoaded', function() {
    const eventTypeField = document.getElementById('id_event_type');
    const yearField = document.getElementById('id_year_occurred');
    const nameLabel = document.querySelector('label[for="id_name"]');

    function updateFormBasedOnType() {
        const eventType = eventTypeField.value;

        if (eventType === 'birthday') {
            nameLabel.textContent = "Person's Name";
            yearField.parentElement.style.display = 'block';
        } else if (eventType === 'anniversary') {
            nameLabel.textContent = "Anniversary Name";
            yearField.parentElement.style.display = 'block';
        } else {
            nameLabel.textContent = "Event Name";
            if (eventType === 'holiday' || eventType === 'custom') {
                yearField.parentElement.style.display = 'none';
            }
        }
    }

    if (eventTypeField) {
        eventTypeField.addEventListener('change', updateFormBasedOnType);
        updateFormBasedOnType();
    }

    // Handle photo upload forms
    const changePhotoInput = document.getElementById('changePhotoInput');
    const addPhotoInput = document.getElementById('addPhotoInput');

    function handlePhotoUpload(input) {
        if (input && input.files && input.files[0]) {
            // Auto-submit the form when a file is selected
            input.closest('form').submit();
        }
    }

    if (changePhotoInput) {
        changePhotoInput.addEventListener('change', () => handlePhotoUpload(changePhotoInput));
    }

    if (addPhotoInput) {
        addPhotoInput.addEventListener('change', () => handlePhotoUpload(addPhotoInput));
    }
});
</script>
{% endblock %}