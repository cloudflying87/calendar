{% extends 'base.html' %}

{% block title %}{{ title }} - Calendar Builder{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header__main">
        <h1 class="page-title">{{ title }}</h1>
    </div>
    <div class="page-header__actions">
        <a href="{% url 'calendars:master_events' %}{% if request.GET.page %}?page={{ request.GET.page }}{% endif %}" class="btn btn--outline">Back to Events</a>
    </div>
</div>

<div class="form-container">
    {% if form.errors %}
        <div class="alert alert-danger">
            <strong>Please correct the errors below:</strong>
            {{ form.errors }}
        </div>
    {% endif %}

    <form method="post" action="" enctype="multipart/form-data" class="form" id="master-event-form">
        {% csrf_token %}
        {% if request.GET.page %}
            <input type="hidden" name="page" value="{{ request.GET.page }}">
        {% endif %}

        <div class="form-group">
            <label for="{{ form.name.id_for_label }}">Event/Person Name</label>
            {{ form.name }}
            {% if form.name.help_text %}
                <small class="form-help">{{ form.name.help_text }}</small>
            {% endif %}
            {% if form.name.errors %}
                <div class="form-errors">{{ form.name.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.event_type.id_for_label }}">Event Type</label>
            {{ form.event_type }}
            {% if form.event_type.help_text %}
                <small class="form-help">{{ form.event_type.help_text }}</small>
            {% endif %}
            {% if form.event_type.errors %}
                <div class="form-errors">{{ form.event_type.errors }}</div>
            {% endif %}
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="{{ form.month.id_for_label }}">Month</label>
                {{ form.month }}
                {% if form.month.errors %}
                    <div class="form-errors">{{ form.month.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.day.id_for_label }}">Day</label>
                {{ form.day }}
                {% if form.day.errors %}
                    <div class="form-errors">{{ form.day.errors }}</div>
                {% endif %}
            </div>
        </div>

        <div class="form-group">
            <label for="{{ form.year_occurred.id_for_label }}">Year (Optional)</label>
            {{ form.year_occurred }}
            {% if form.year_occurred.help_text %}
                <small class="form-help">For birthdays and anniversaries - the year it first occurred</small>
            {% endif %}
            {% if form.year_occurred.errors %}
                <div class="form-errors">{{ form.year_occurred.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.groups.id_for_label }}">Groups</label>
            {{ form.groups }}
            {% if form.groups.help_text %}
                <small class="form-help">Comma-separated list (e.g., "Family, Birthdays, Important")</small>
            {% endif %}
            {% if form.groups.errors %}
                <div class="form-errors">{{ form.groups.errors }}</div>
            {% endif %}
            {% if groups %}
                <div class="form-help">
                    <strong>Existing groups:</strong>
                    {% for group in groups %}
                        <span class="tag">{{ group.name }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="{{ form.description.id_for_label }}">Description (Optional)</label>
            {{ form.description }}
            {% if form.description.errors %}
                <div class="form-errors">{{ form.description.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="master-event-image">Default Image (Optional)</label>
            <div class="master-event-photo-section">
                <div class="photo-container">
                    <div class="current-photo" id="currentPhotoDiv">
                        {% if form.instance.image %}
                            <img src="{{ form.instance.image.url }}" alt="{{ form.instance.name }}" class="master-event-photo" id="currentPhoto">
                        {% else %}
                            <div class="no-photo-placeholder" id="noPhotoPlaceholder">
                                <span class="no-photo-icon">üì∑</span>
                                <span class="no-photo-text">No photo selected</span>
                            </div>
                        {% endif %}
                    </div>

                    <div class="photo-actions">
                        {% if form.instance.pk %}
                            <input type="file" name="photo_upload" accept="image/*" style="display: none;" id="photoInput">
                            <label for="photoInput" class="btn btn--primary btn--small">
                                {% if form.instance.image %}‚úèÔ∏è Change Photo{% else %}üì∑ Add Photo{% endif %}
                            </label>

                            <div class="photo-preview-actions" id="previewActions" style="display: none;">
                                <button type="button" class="btn btn--secondary btn--small" id="cropBtn">
                                    ‚úÇÔ∏è Crop & Save
                                </button>
                                <button type="button" class="btn btn--outline btn--small" id="cancelBtn">
                                    ‚ùå Cancel
                                </button>
                            </div>

                            {% if form.instance.image %}
                                <button type="button" class="btn btn--outline btn--small" onclick="removePhoto({{ form.instance.pk }})">
                                    üóëÔ∏è Remove Photo
                                </button>
                            {% endif %}
                        {% else %}
                            <p class="form-help">Save the event first to add a photo</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <small class="form-help">This image will be used as the default for all calendar events created from this master event</small>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn--primary" id="submit-btn">Save Event</button>
            <a href="{% url 'calendars:master_events' %}{% if request.GET.page %}?page={{ request.GET.page }}{% endif %}" class="btn btn--outline">Cancel</a>
        </div>
    </form>
</div>

<script>
// Auto-update form based on event type
document.addEventListener('DOMContentLoaded', function() {
    const eventTypeField = document.getElementById('id_event_type');
    const yearField = document.getElementById('id_year_occurred');
    const nameLabel = document.querySelector('label[for="id_name"]');

    function updateFormBasedOnType() {
        const eventType = eventTypeField.value;

        if (eventType === 'birthday') {
            nameLabel.textContent = "Person's Name";
            yearField.parentElement.style.display = 'block';
        } else if (eventType === 'anniversary') {
            nameLabel.textContent = "Anniversary Name";
            yearField.parentElement.style.display = 'block';
        } else {
            nameLabel.textContent = "Event Name";
            if (eventType === 'holiday' || eventType === 'custom') {
                yearField.parentElement.style.display = 'none';
            }
        }
    }

    if (eventTypeField) {
        eventTypeField.addEventListener('change', updateFormBasedOnType);
        updateFormBasedOnType();
    }

    // Handle photo upload with inline preview
    const photoInput = document.getElementById('photoInput');
    const currentPhoto = document.getElementById('currentPhoto');
    const currentPhotoDiv = document.getElementById('currentPhotoDiv');
    const noPhotoPlaceholder = document.getElementById('noPhotoPlaceholder');
    const previewActions = document.getElementById('previewActions');
    const cropBtn = document.getElementById('cropBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    let selectedFile = null;
    let originalImageSrc = currentPhoto ? currentPhoto.src : null;

    if (photoInput) {
        photoInput.addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                selectedFile = e.target.files[0];
                showImagePreview(selectedFile);
            }
        });
    }

    function showImagePreview(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            // Hide placeholder if it exists
            if (noPhotoPlaceholder) {
                noPhotoPlaceholder.style.display = 'none';
            }

            // Show or update the image
            if (currentPhoto) {
                currentPhoto.src = e.target.result;
            } else {
                // Create new image element
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = 'Preview';
                img.className = 'master-event-photo';
                img.id = 'currentPhoto';
                currentPhotoDiv.appendChild(img);
            }

            // Show preview actions
            previewActions.style.display = 'flex';
        };
        reader.readAsDataURL(file);
    }

    function cancelPreview() {
        // Reset file input
        photoInput.value = '';
        selectedFile = null;

        // Restore original image or show placeholder
        if (originalImageSrc) {
            currentPhoto.src = originalImageSrc;
        } else {
            // Remove the preview image and show placeholder
            const previewImg = document.getElementById('currentPhoto');
            if (previewImg && !originalImageSrc) {
                previewImg.remove();
            }
            if (noPhotoPlaceholder) {
                noPhotoPlaceholder.style.display = 'block';
            }
        }

        // Hide preview actions
        previewActions.style.display = 'none';
    }

    function uploadAndCrop() {
        if (!selectedFile) return;

        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('image', selectedFile);

        // Get the upload URL (we need to construct it)
        const uploadUrl = `/calendars/master-events/{{ form.instance.pk }}/upload-image/`;

        // Store current page in session for later redirect
        const currentPage = new URLSearchParams(window.location.search).get('page');
        if (currentPage) {
            formData.append('page', currentPage);
        }

        fetch(uploadUrl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.redirect_to_crop) {
                // Redirect to crop page
                window.location.href = data.crop_url;
            } else {
                alert('Error: ' + (data.error || 'Upload failed'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Upload failed. Please try again.');
        });
    }

    // Event listeners
    if (cancelBtn) {
        cancelBtn.addEventListener('click', cancelPreview);
    }

    if (cropBtn) {
        cropBtn.addEventListener('click', uploadAndCrop);
    }

    // Debug form submission
    const form = document.getElementById('master-event-form');
    const submitBtn = document.getElementById('submit-btn');

    // Handle photo removal without nested form
    window.removePhoto = function(eventId) {
        if (confirm('Remove this photo?')) {
            const removeUrl = `/calendars/master-events/${eventId}/remove-image/`;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Create a temporary form to submit the removal
            const tempForm = document.createElement('form');
            tempForm.method = 'POST';
            tempForm.action = removeUrl;

            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            tempForm.appendChild(csrfInput);

            document.body.appendChild(tempForm);
            tempForm.submit();
        }
    };

    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('Form submit event triggered');
            // Don't prevent default - let it submit
        });
    }

    if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            console.log('Submit button clicked');
            console.log('Form validity:', form.checkValidity());
            if (!form.checkValidity()) {
                form.reportValidity();
            }
        });
    }
});
</script>

<style>
.photo-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.current-photo {
    display: flex;
    justify-content: center;
}

.master-event-photo {
    width: var(--calendar-image-width);
    height: var(--calendar-image-height);
    aspect-ratio: var(--calendar-aspect-ratio);
    object-fit: cover;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.no-photo-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: var(--calendar-image-width);
    height: var(--calendar-image-height);
    aspect-ratio: var(--calendar-aspect-ratio);
    padding: 2rem;
    border: 2px dashed var(--color-border);
    border-radius: var(--border-radius);
    color: var(--color-text-secondary);
    background: var(--color-background-light, #f8f9fa);
}

.no-photo-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    opacity: 0.7;
}

.photo-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    flex-wrap: wrap;
}

.photo-preview-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
}

.inline-form {
    display: inline-block;
}

@media (max-width: 768px) {
    .master-event-photo,
    .no-photo-placeholder {
        width: var(--calendar-image-width-mobile);
        height: var(--calendar-image-height-mobile);
    }

    .photo-actions {
        flex-direction: column;
        align-items: center;
    }

    .photo-preview-actions {
        flex-direction: column;
    }
}

@media (max-width: 480px) {
    .master-event-photo,
    .no-photo-placeholder {
        width: var(--calendar-image-width-small);
        height: var(--calendar-image-height-small);
    }
}
</style>
{% endblock %}