{% extends 'base.html' %}

{% block title %}Master Events - Calendar Builder{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header__main">
        <h1 class="page-title">Master Events</h1>
        <p class="page-description">Manage your recurring events that can be reused across calendars</p>
    </div>
    <div class="page-header__actions">
        <a href="{% url 'calendars:import_master_events' %}" class="btn btn--outline">üì• Import</a>
        <a href="{% url 'calendars:export_master_events' %}?format=csv" class="btn btn--outline">üì§ Export CSV</a>
        <a href="{% url 'calendars:export_master_events' %}?format=json" class="btn btn--outline">üì§ Export JSON</a>
        {% if events %}
            <a href="{% url 'calendars:delete_all_master_events' %}" class="btn btn--danger">üóëÔ∏è Delete All</a>
        {% endif %}
        <a href="{% url 'calendars:master_event_create' %}" class="btn btn--primary">‚ûï Add Event</a>
    </div>
</div>

<!-- Search and Filter -->
<div class="filter-panel">
    <form method="get" class="filter-form">
        <div class="form-group form-group--inline">
            <input type="text" name="search" placeholder="Search events..." value="{{ request.GET.search }}" class="form-input">
            <select name="group" class="form-select">
                <option value="">All Groups</option>
                {% for group in groups %}
                    <option value="{{ group.name }}" {% if request.GET.group == group.name %}selected{% endif %}>{{ group.name }}</option>
                {% endfor %}
            </select>
            <select name="month" class="form-select">
                <option value="">All Months</option>
                {% for month_num, month_name in months %}
                    <option value="{{ month_num }}" {% if request.GET.month == month_num|stringformat:"s" %}selected{% endif %}>{{ month_name }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn--secondary">Filter</button>
            <a href="{% url 'calendars:master_events' %}" class="btn btn--outline">Clear</a>
        </div>
    </form>
</div>

{% if events %}
    <div class="events-grid">
        {% for event in events %}
            <div class="event-card" data-event-id="{{ event.id }}">
                <div class="event-card__image-container">
                    <div class="event-card__image-wrapper">
                        {% if event.image %}
                            <img src="{{ event.image.url }}" alt="{{ event.name }}" class="event-card__image">
                        {% else %}
                            <div class="event-card__placeholder">
                                <span class="event-card__placeholder-text">No Image</span>
                            </div>
                        {% endif %}
                        <button class="event-card__image-edit" onclick="editMasterEventPhoto({{ event.id }})">
                            <span>üì∑</span>
                        </button>
                    </div>
                </div>

                <div class="event-card__content">
                    <h3 class="event-card__name">{{ event.name }}</h3>
                    <div class="event-card__meta">
                        <span class="badge badge--{{ event.event_type }}">{{ event.get_event_type_display }}</span>
                        <span class="event-card__date">{{ event.month }}/{{ event.day }}</span>
                        {% if event.year_occurred %}
                            <span class="event-card__year">Year: {{ event.year_occurred }}</span>
                            {% load calendar_extras %}
                            {% calculate_current_age event.year_occurred event.event_type as current_age %}
                            {% if current_age %}
                                <span class="event-card__current-age">Current: {{ current_age }}</span>
                            {% endif %}
                        {% endif %}
                    </div>
                    {% if event.groups %}
                        <div class="event-card__groups">
                            {% for group in event.get_groups_list %}
                                <span class="tag">{{ group }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if event.description %}
                        <p class="event-card__description">{{ event.description|truncatewords:20 }}</p>
                    {% endif %}
                    <div class="event-card__actions">
                        <a href="{% url 'calendars:unified_photo_editor' %}?master_event_id={{ event.pk }}" class="btn btn--small btn--outline">Edit</a>
                        <a href="{% url 'calendars:master_event_delete' pk=event.pk %}" class="btn btn--small btn--danger">Delete</a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    {% if is_paginated %}
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?page=1" class="pagination__link">First</a>
                <a href="?page={{ page_obj.previous_page_number }}" class="pagination__link">Previous</a>
            {% endif %}

            <span class="pagination__info">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
            </span>

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}" class="pagination__link">Next</a>
                <a href="?page={{ page_obj.paginator.num_pages }}" class="pagination__link">Last</a>
            {% endif %}
        </div>
    {% endif %}
{% else %}
    <div class="empty-state">
        <h2>No Master Events Yet</h2>
        <p>Start by adding recurring events that you can reuse across multiple calendars.</p>
        <a href="{% url 'calendars:master_event_create' %}" class="btn btn--primary">‚ûï Add Your First Event</a>
    </div>
{% endif %}

<style>
.events-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
}

.event-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
}

.event-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.event-card__image-container {
    position: relative;
    width: 100%;
    padding-top: var(--calendar-aspect-padding); /* 1.6:1 aspect ratio */
    background: #f3f4f6;
}

.event-card__image-wrapper {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
}

.event-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.event-card__placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
}

.event-card__placeholder-text {
    color: #9ca3af;
    font-size: 1.25rem;
    font-weight: 500;
}

.event-card__image-edit {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: rgba(255, 255, 255, 0.9);
    border: 2px solid #2563eb;
    border-radius: 8px;
    padding: 0.5rem;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 1.25rem;
}

.event-card__image-edit:hover {
    background: white;
}

.hidden-file-input {
    position: absolute;
    left: -9999px;
    opacity: 0;
    pointer-events: none;
}

.event-card__content {
    padding: 1rem;
}

.event-card__name {
    margin: 0 0 0.75rem 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
    line-height: 1.3;
}

.event-card__meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
}

.event-card__date,
.event-card__year,
.event-card__current-age {
    color: #6b7280;
    font-size: 0.875rem;
}

.event-card__current-age {
    background: #f0f9ff;
    color: #0369a1;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-weight: 500;
}

.event-card__groups {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    margin-bottom: 0.75rem;
}

.event-card__description {
    margin: 0.75rem 0;
    color: #4b5563;
    font-size: 0.875rem;
    line-height: 1.5;
}

.event-card__actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

.badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.badge--birthday { background: #fef3c7; color: #92400e; }
.badge--anniversary { background: #fce7f3; color: #9f1239; }
.badge--holiday { background: #dbeafe; color: #1e40af; }
.badge--custom { background: #e5e7eb; color: #374151; }
.badge--appointment { background: #d1fae5; color: #065f46; }
.badge--reminder { background: #f3e8ff; color: #6b21a8; }
</style>

<script>
function editMasterEventPhoto(eventId) {
    // Redirect to the unified photo editor with master event context
    window.location.href = `/calendars/upload-edit/?master_event_id=${eventId}`;
}
</script>
{% endblock %}