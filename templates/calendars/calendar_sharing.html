{% extends 'base.html' %}

{% block title %}Share {{ calendar.year }} Calendar - Calendar Builder{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header__main">
        <h1 class="page-title">Share Calendar</h1>
        <p class="page-subtitle">{{ calendar.year }} {{ calendar.name|default:"Calendar" }}</p>
    </div>
    <div class="page-header__actions">
        <a href="{% url 'calendars:calendar_detail_by_id' calendar_id=calendar.id %}" class="btn btn--outline">Back to Calendar</a>
    </div>
</div>

<div class="content-container">
    <!-- Calendar Info Panel -->
    <div class="info-panel">
        <div class="info-panel__header">
            <h3>📅 Calendar Information</h3>
        </div>
        <div class="info-panel__content">
            <div class="calendar-stats">
                <div class="stat-item">
                    <span class="stat-label">Year:</span>
                    <span class="stat-value">{{ calendar.year }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Events:</span>
                    <span class="stat-value">{{ calendar.events.count }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Created:</span>
                    <span class="stat-value">{{ calendar.created_at|date:"M d, Y" }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Private Sharing Section -->
    <div class="sharing-panel">
        <div class="sharing-panel__header">
            <h3>👥 Private Sharing</h3>
            <p>Share with specific users by email address</p>
        </div>

        <!-- Share Form -->
        <form method="post" action="{% url 'calendars:calendar_share' year=calendar.year %}" class="share-form">
            {% csrf_token %}
            <div class="form-group form-group--inline">
                <input type="email" name="email" placeholder="Enter email address" class="form-input" required>
                <select name="permission_level" class="form-select">
                    <option value="viewer">Viewer</option>
                    <option value="editor">Editor</option>
                </select>
                <button type="submit" class="btn btn--primary">Send Invitation</button>
            </div>
        </form>

        <!-- Current Shares -->
        {% if calendar.shares.exists %}
        <div class="current-shares">
            <h4>Currently Shared With</h4>
            <div class="shares-list">
                {% for share in calendar.shares.all %}
                <div class="share-item">
                    <div class="share-item__info">
                        <div class="share-item__user">
                            <strong>{{ share.shared_with.username }}</strong>
                            <span class="share-item__email">({{ share.shared_with.email }})</span>
                        </div>
                        <span class="share-item__permission permission-badge permission-badge--{{ share.permission_level }}">
                            {{ share.get_permission_level_display }}
                        </span>
                    </div>
                    <form method="post" action="{% url 'calendars:calendar_unshare' year=calendar.year %}" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="share_id" value="{{ share.id }}">
                        <button type="submit" class="btn btn--small btn--danger" title="Remove access"
                                onclick="return confirm('Remove {{ share.shared_with.username }} from this calendar?')">
                            Remove Access
                        </button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Pending Invitations -->
        {% if calendar.invitations.exists %}
        <div class="pending-invitations">
            <h4>Pending Invitations</h4>
            <div class="invitations-list">
                {% for invitation in calendar.invitations.all %}
                <div class="invitation-item">
                    <div class="invitation-item__info">
                        <span class="invitation-item__email">{{ invitation.email }}</span>
                        <span class="invitation-item__permission permission-badge permission-badge--{{ invitation.permission_level }}">
                            {{ invitation.get_permission_level_display }}
                        </span>
                        <span class="invitation-item__date">
                            Sent {{ invitation.created_at|timesince }} ago
                        </span>
                    </div>
                    <form method="post" action="{% url 'calendars:calendar_unshare' year=calendar.year %}" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="invitation_id" value="{{ invitation.id }}">
                        <button type="submit" class="btn btn--small btn--outline" title="Cancel invitation"
                                onclick="return confirm('Cancel invitation to {{ invitation.email }}?')">
                            Cancel
                        </button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Digital Calendar Panel -->
    <div class="sharing-panel sharing-panel--featured">
        <div class="sharing-panel__header">
            <h3>📱 Digital Calendar</h3>
            <p>Share your beautiful digital calendar - the best way to view your calendar online</p>
        </div>
        <div class="digital-calendar-preview">
            <div class="feature-highlights">
                <div class="feature-item">📸 <strong>Header Images:</strong> Beautiful monthly headers</div>
                <div class="feature-item">📱 <strong>Mobile Friendly:</strong> Perfect on all devices</div>
                <div class="feature-item">🔍 <strong>Click to Expand:</strong> View full-size photos</div>
                <div class="feature-item">🗓️ <strong>Interactive:</strong> Navigate month by month</div>
            </div>
            <div class="digital-actions">
                <a href="{% url 'calendars:digital_calendar' calendar_id=calendar.id %}" class="btn btn--primary btn--large">
                    👁️ Preview Digital Calendar
                </a>
                {% if calendar.is_publicly_shared %}
                    <div class="digital-share-info">
                        <p>Public sharing is enabled - your digital calendar is ready to share!</p>
                        <div class="url-copy-container">
                            <input type="text" id="digital-url" readonly value="{{ request.scheme }}://{{ request.get_host }}{% url 'calendars:digital_calendar' calendar_id=calendar.id %}" class="url-input">
                            <button onclick="copyDigitalUrl()" class="btn btn--small btn--outline">Copy Digital Link</button>
                        </div>
                    </div>
                {% else %}
                    <p class="enable-sharing-note">Enable public sharing below to get a shareable digital calendar link</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Public Sharing Panel -->
    <div class="sharing-panel">
        <div class="sharing-panel__header">
            <h3>🌐 Public Sharing</h3>
            <p>Allow anyone with the link to view your calendar</p>
        </div>

        {% if calendar.is_publicly_shared %}
            <div class="public-share-active">
                <div class="share-status">
                    <span class="status status--success">✅ Public Sharing Enabled</span>
                    <p>Anyone with this link can view your calendar</p>
                </div>

                <div class="public-share-url">
                    <label for="public-url">Public URL:</label>
                    <div class="url-copy-container">
                        <input type="text" id="public-url" readonly value="{{ public_share_url }}" class="url-input">
                        <button onclick="copyPublicUrl()" class="btn btn--small btn--outline">Copy Link</button>
                    </div>
                </div>

                <div class="public-share-actions">
                    <a href="{{ public_share_url }}" target="_blank" class="btn btn--secondary btn--small">
                        👁️ Preview Public View
                    </a>
                    <form method="post" action="{% url 'calendars:disable_public_share' calendar_id=calendar.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn--small btn--danger" onclick="return confirm('Disable public sharing? The current link will stop working.')">
                            Disable Public Sharing
                        </button>
                    </form>
                </div>
            </div>
        {% else %}
            <div class="public-share-inactive">
                <div class="inactive-message">
                    <h4>🔒 Public Sharing Disabled</h4>
                    <p>Enable public sharing to create a shareable link that anyone can use to view your calendar</p>
                </div>
                <form method="post" action="{% url 'calendars:enable_public_share' calendar_id=calendar.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn--primary">
                        🌐 Enable Public Sharing
                    </button>
                </form>
            </div>
        {% endif %}
    </div>

    <!-- Social Sharing Section -->
    {% if calendar.is_publicly_shared %}
        <div class="sharing-panel">
            <div class="sharing-panel__header">
                <h3>📤 Social Media Sharing</h3>
                <p>Share your calendar on social media platforms</p>
            </div>
            {% include 'components/social_share.html' with page_title=calendar.year|stringformat:"s Calendar" share_url=public_share_url %}
        </div>
    {% else %}
        <div class="sharing-panel sharing-panel--disabled">
            <div class="sharing-panel__header">
                <h3>📤 Social Media Sharing</h3>
                <p>Enable public sharing to unlock social media sharing features</p>
            </div>
            <div class="disabled-feature">
                <p>🔒 Social media sharing is available once you enable public sharing above</p>
            </div>
        </div>
    {% endif %}
</div>

<script>
function copyPublicUrl() {
    const urlInput = document.getElementById('public-url');
    const url = urlInput.value;
    const button = event.target;
    const originalText = button.textContent;

    // Try multiple copy methods for better browser compatibility
    let copySuccess = false;

    // Method 1: Modern clipboard API (works in HTTPS and secure contexts)
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(url).then(function() {
            button.textContent = '✅ Copied!';
            button.classList.add('btn--success');
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('btn--success');
            }, 2000);
        }).catch(function(err) {
            tryFallbackCopy();
        });
    } else {
        tryFallbackCopy();
    }

    function tryFallbackCopy() {
        // Method 2: Fallback using execCommand (deprecated but widely supported)
        try {
            urlInput.select();
            urlInput.setSelectionRange(0, 99999); // For mobile devices
            copySuccess = document.execCommand('copy');

            if (copySuccess) {
                button.textContent = '✅ Copied!';
                button.classList.add('btn--success');
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('btn--success');
                }, 2000);
            } else {
                throw new Error('execCommand failed');
            }
        } catch (err) {
            // Method 3: Manual selection with user notification
            urlInput.select();
            urlInput.setSelectionRange(0, 99999);
            button.textContent = '📋 Selected - Press Ctrl+C';
            button.classList.add('btn--warning');
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('btn--warning');
            }, 3000);
        }
    }
}

function copyDigitalUrl() {
    const urlInput = document.getElementById('digital-url');
    const url = urlInput.value;
    const button = event.target;
    const originalText = button.textContent;

    // Try multiple copy methods for better browser compatibility
    let copySuccess = false;

    // Method 1: Modern clipboard API (works in HTTPS and secure contexts)
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(url).then(function() {
            button.textContent = '✅ Copied!';
            button.classList.add('btn--success');
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('btn--success');
            }, 2000);
        }).catch(function(err) {
            tryFallbackCopy();
        });
    } else {
        tryFallbackCopy();
    }

    function tryFallbackCopy() {
        // Method 2: Fallback using execCommand (deprecated but widely supported)
        try {
            urlInput.select();
            urlInput.setSelectionRange(0, 99999); // For mobile devices
            copySuccess = document.execCommand('copy');

            if (copySuccess) {
                button.textContent = '✅ Copied!';
                button.classList.add('btn--success');
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('btn--success');
                }, 2000);
            } else {
                throw new Error('execCommand failed');
            }
        } catch (err) {
            // Method 3: Manual selection with user notification
            urlInput.select();
            button.textContent = '⚠️ Please copy manually';
            button.classList.add('btn--warning');
            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('btn--warning');
            }, 3000);
        }
    }
}
</script>

<style>
.content-container {
    max-width: 800px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.info-panel {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.info-panel__header {
    background: var(--color-background-light);
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--color-border);
}

.info-panel__header h3 {
    margin: 0;
    color: var(--color-text-primary);
}

.info-panel__content {
    padding: 1.5rem;
}

.calendar-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.stat-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    font-weight: 500;
}

.stat-value {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-text-primary);
}

.sharing-panel {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.sharing-panel--disabled {
    opacity: 0.7;
}

.sharing-panel--featured {
    border: 2px solid var(--color-primary);
    background: linear-gradient(135deg, #fdfcfb 0%, #e2eef7 100%);
}

.digital-calendar-preview {
    padding: 1.5rem;
}

.feature-highlights {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}

.feature-highlights .feature-item {
    background: white;
    padding: 0.75rem;
    border-radius: var(--border-radius-sm);
    font-size: 0.875rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.digital-actions {
    text-align: center;
}

.btn--large {
    padding: 1rem 2rem;
    font-size: 1.125rem;
    margin-bottom: 1rem;
}

.digital-share-info {
    background: white;
    padding: 1rem;
    border-radius: var(--border-radius-sm);
    margin-top: 1rem;
}

.digital-share-info p {
    margin: 0 0 1rem 0;
    color: var(--color-text-secondary);
    font-size: 0.875rem;
}

.enable-sharing-note {
    color: var(--color-text-secondary);
    font-size: 0.875rem;
    margin: 1rem 0 0 0;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.7);
    border-radius: var(--border-radius-sm);
}

.sharing-panel__header {
    background: var(--color-background-light);
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--color-border);
}

.sharing-panel__header h3 {
    margin: 0 0 0.25rem 0;
    color: var(--color-text-primary);
}

.sharing-panel__header p {
    margin: 0;
    color: var(--color-text-secondary);
    font-size: 0.875rem;
}

.share-form {
    padding: 1.5rem;
    border-bottom: 1px solid var(--color-border);
}

.form-group--inline {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.form-input {
    flex: 2;
    min-width: 200px;
}

.form-select {
    flex: 1;
    min-width: 120px;
}

.current-shares,
.pending-invitations {
    padding: 1.5rem;
}

.current-shares h4,
.pending-invitations h4 {
    margin: 0 0 1rem 0;
    color: var(--color-text-primary);
    font-size: 1rem;
}

.shares-list,
.invitations-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.share-item,
.invitation-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-sm);
    background: var(--color-background-light);
}

.share-item__info,
.invitation-item__info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    flex: 1;
}

.share-item__user {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.share-item__email,
.invitation-item__email {
    color: var(--color-text-secondary);
    font-size: 0.875rem;
}

.invitation-item__date {
    color: var(--color-text-secondary);
    font-size: 0.75rem;
}

.permission-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.permission-badge--viewer {
    background: #e0f2fe;
    color: #0277bd;
}

.permission-badge--editor {
    background: #e8f5e8;
    color: #2e7d32;
}

.public-share-active {
    padding: 1.5rem;
}

.public-share-inactive {
    padding: 1.5rem;
    text-align: center;
}

.share-status {
    margin-bottom: 1.5rem;
}

.status {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: var(--border-radius-sm);
    font-weight: 600;
}

.status--success {
    background: #e8f5e8;
    color: #2e7d32;
}

.share-status p {
    margin: 0.5rem 0 0 0;
    color: var(--color-text-secondary);
    font-size: 0.875rem;
}

.public-share-url {
    margin-bottom: 1.5rem;
}

.public-share-url label {
    display: block;
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: var(--color-text-primary);
}

.url-copy-container {
    display: flex;
    gap: 0.5rem;
}

.url-input {
    flex: 1;
    font-family: monospace;
    font-size: 0.875rem;
    padding: 0.75rem;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius-sm);
    background: var(--color-background-light);
}

.public-share-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.inactive-message {
    margin-bottom: 1.5rem;
}

.inactive-message h4 {
    margin: 0 0 0.5rem 0;
    color: var(--color-text-primary);
}

.inactive-message p {
    margin: 0;
    color: var(--color-text-secondary);
}

.disabled-feature {
    padding: 1rem;
    background: var(--color-background-light);
    border-radius: var(--border-radius-sm);
    text-align: center;
}

.disabled-feature p {
    margin: 0;
    color: var(--color-text-secondary);
    font-style: italic;
}

.btn--success {
    background: var(--color-success, #10b981);
    border-color: var(--color-success, #10b981);
    color: white;
}

.btn--warning {
    background: var(--color-warning, #f59e0b);
    border-color: var(--color-warning, #f59e0b);
    color: white;
}

/* Responsive design */
@media (max-width: 768px) {
    .form-group--inline {
        flex-direction: column;
        align-items: stretch;
    }

    .share-item,
    .invitation-item {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }

    .url-copy-container {
        flex-direction: column;
    }

    .public-share-actions {
        flex-direction: column;
    }

    .feature-highlights {
        grid-template-columns: 1fr;
    }

    .btn--large {
        padding: 0.875rem 1.5rem;
        font-size: 1rem;
    }

    .calendar-stats {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}