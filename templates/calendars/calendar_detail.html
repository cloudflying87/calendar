{% extends 'base.html' %}

{% block title %}Calendar {{ calendar.year }} - Calendar Builder{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header__main">
        <h1 class="page-title">Calendar {{ calendar.year }}</h1>
        <div class="page-meta">
            <span class="meta-item">{{ calendar.events.count }} events</span>
            <span class="meta-item">
                {% if has_header %}
                    <span class="status status--success">Header Available</span>
                {% else %}
                    <span class="status status--warning">No Header</span>
                {% endif %}
            </span>
        </div>
    </div>
    <div class="page-header__actions">
        <a href="{% url 'calendars:calendar_list' %}" class="btn btn--outline">Back to Calendars</a>
        <a href="{% url 'calendars:delete_calendar' year=calendar.year %}" class="btn btn--danger">🗑️ Delete Calendar</a>
    </div>
</div>

<div class="action-panel">
    <div class="action-panel__section">
        <h3>Manage Content</h3>
        <div class="action-buttons">
            <a href="{% url 'calendars:photo_editor_upload' year=calendar.year %}" class="btn btn--primary" title="Upload and edit a single photo with custom date and event name">
                ✏️ Upload & Edit Photo
            </a>
            <a href="{% url 'calendars:image_upload' year=calendar.year %}" class="btn btn--secondary" title="Bulk upload multiple photos (requires MMDD_eventname format)">
                📁 Bulk Upload Photos
            </a>
            {% if calendar.events.exists %}
            <a href="{% url 'calendars:download_all_photos' year=calendar.year %}" class="btn btn--secondary" title="Download all calendar photos as a ZIP file">
                📥 Download All Photos
            </a>
            {% endif %}
            <a href="{% url 'calendars:holiday_management' year=calendar.year %}" class="btn btn--secondary">
                🎉 Manage Holidays
            </a>
            <a href="{% url 'calendars:header_upload' year=calendar.year %}" class="btn btn--secondary">
                📄 {% if has_header %}Update Header{% else %}Upload Header{% endif %}
            </a>
        </div>
    </div>

    <div class="action-panel__section">
        <h3>Generate Calendar</h3>
        <form method="post" action="{% url 'calendars:generate_calendar' year=calendar.year %}" class="inline-form">
            {% csrf_token %}
            <div class="form-group form-group--inline">
                <select name="generation_type" class="form-select" required>
                    <option value="">Select format...</option>
                    <option value="calendar_only">Calendar Only</option>
                    {% if has_header %}
                        <option value="with_headers">With Headers</option>
                        <option value="combined">Combined Spread</option>
                    {% endif %}
                </select>
                <button type="submit" class="btn btn--success">Generate PDF</button>
            </div>
        </form>
    </div>
</div>

<!-- Calendar Sharing Section -->
{% if user_can_share %}
<div class="sharing-panel">
    <h3>Share Calendar</h3>

    <!-- Share Form -->
    <form method="post" action="{% url 'calendars:calendar_share' year=calendar.year %}" class="share-form">
        {% csrf_token %}
        <div class="form-group form-group--inline">
            <input type="email" name="email" placeholder="Enter email address" class="form-input" required>
            <select name="permission_level" class="form-select">
                <option value="viewer">Viewer</option>
                <option value="editor">Editor</option>
            </select>
            <button type="submit" class="btn btn--primary">Share</button>
        </div>
    </form>

    <!-- Current Shares -->
    {% if calendar.shares.exists %}
    <div class="current-shares">
        <h4>Shared With</h4>
        <div class="shares-list">
            {% for share in calendar.shares.all %}
            <div class="share-item">
                <div class="share-item__info">
                    <strong>{{ share.shared_with.username }}</strong>
                    <span class="share-item__email">({{ share.shared_with.email }})</span>
                    <span class="share-item__permission">{{ share.get_permission_level_display }}</span>
                </div>
                <form method="post" action="{% url 'calendars:calendar_unshare' year=calendar.year %}" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="share_id" value="{{ share.id }}">
                    <button type="submit" class="btn btn--small btn--danger" title="Remove access"
                            onclick="return confirm('Remove {{ share.shared_with.username }} from this calendar?')">
                        Remove
                    </button>
                </form>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Pending Invitations -->
    {% if calendar.invitations.exists %}
    <div class="pending-invitations">
        <h4>Pending Invitations</h4>
        <div class="invitations-list">
            {% for invitation in calendar.invitations.all %}
            {% if not invitation.accepted and not invitation.is_expired %}
            <div class="invitation-item">
                <div class="invitation-item__info">
                    <strong>{{ invitation.email }}</strong>
                    <span class="invitation-item__permission">{{ invitation.get_permission_level_display }}</span>
                    <span class="invitation-item__date">Sent {{ invitation.created_at|date:"M j" }}</span>
                </div>
                <span class="status status--warning">Pending</span>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

{% if generated_calendars %}
    <div class="generated-calendars">
        <h3>Generated Calendars</h3>
        <div class="calendar-downloads">
            {% for generated in generated_calendars %}
                <div class="download-item">
                    <div class="download-item__info">
                        <strong>{{ generated.get_generation_type_display }}</strong>
                        <span class="download-item__date">{{ generated.created_at|date:"M j, Y g:i A" }}</span>
                    </div>
                    <div class="download-item__actions">
                        <a href="{% url 'calendars:download_calendar' year=calendar.year generation_type=generated.generation_type %}"
                           class="btn btn--small btn--outline">Download PDF</a>
                        <form method="post" action="{% url 'calendars:delete_generated_pdf' pdf_id=generated.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this generated PDF?');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn--small btn--danger" title="Delete PDF">
                                🗑️
                            </button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
{% endif %}

<div class="calendar-overview">
    <h3>Events by Month</h3>
    <div class="months-grid">
        {% for month, events in events_by_month.items %}
            <div class="month-card">
                <div class="month-card__header">
                    <h4 class="month-card__title">
                        {% if month == 1 %}January{% elif month == 2 %}February{% elif month == 3 %}March{% elif month == 4 %}April{% elif month == 5 %}May{% elif month == 6 %}June{% elif month == 7 %}July{% elif month == 8 %}August{% elif month == 9 %}September{% elif month == 10 %}October{% elif month == 11 %}November{% elif month == 12 %}December{% endif %}
                    </h4>
                    <span class="month-card__count">{{ events.count }} events</span>
                </div>

                {% if events %}
                    <div class="month-card__events">
                        {% for event in events %}
                            <div class="event-item" id="event-{{ event.id }}">
                                <div class="event-item__day">{{ event.day }}</div>
                                <div class="event-item__info">
                                    <div class="event-item__name">{{ event.event_name }}</div>
                                    {% if event.image %}
                                        <div class="event-item__image">
                                            <img src="{{ event.image.url }}" alt="{{ event.event_name }}" class="event-thumbnail">
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="event-item__actions">
                                    <a href="{% url 'calendars:edit_event' event_id=event.id %}" class="btn btn--small btn--outline" title="Edit event">
                                        Edit
                                    </a>
                                    <form method="post" action="{% url 'calendars:delete_event' event_id=event.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this event?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn--small btn--danger" title="Delete event">
                                            Delete
                                        </button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="month-card__empty">
                        <span class="empty-text">No events</span>
                    </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}