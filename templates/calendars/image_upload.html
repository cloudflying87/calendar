{% extends 'base.html' %}

{% block title %}Bulk Upload Photos - Calendar {{ calendar.year }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">üìÅ Bulk Upload Photos for {{ calendar.year }}</h1>
    <a href="{% url 'calendars:calendar_detail' year=calendar.year %}" class="btn btn--outline">Back to Calendar</a>
</div>

<div class="upload-instructions">
    <div class="instruction-card">
        <h3 class="instruction-card__title">File Naming Format</h3>
        <div class="instruction-card__content">
            <p>Name your image files using either format:</p>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                <li><strong>MMDD eventname.jpg</strong> (space separator)</li>
                <li><strong>MMDD_eventname.jpg</strong> (underscore separator)</li>
            </ul>
            <div class="examples">
                <div class="example-item">
                    <code>0121 Brynn's Birthday.png</code>
                    <span class="example-description">January 21st - Brynn's Birthday</span>
                </div>
                <div class="example-item">
                    <code>0101 New Years Day.jpg</code>
                    <span class="example-description">January 1st - New Years Day</span>
                </div>
                <div class="example-item">
                    <code>0314_birthday_party.jpg</code>
                    <span class="example-description">March 14th - Birthday Party</span>
                </div>
                <div class="example-item">
                    <code>1225 Christmas.png</code>
                    <span class="example-description">December 25th - Christmas</span>
                </div>
                <div class="example-item">
                    <code>0701_vacation_start.jpeg</code>
                    <span class="example-description">July 1st - Vacation Start</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="form-container">
    <form method="post" enctype="multipart/form-data" class="form">
        {% csrf_token %}

        <div class="form-group">
            <label for="{{ form.images.id_for_label }}" class="form-label">
                {{ form.images.label }}
            </label>
            {{ form.images }}
            {% if form.images.help_text %}
                <div class="form-help">{{ form.images.help_text }}</div>
            {% endif %}
            {% if form.images.errors %}
                <div class="form-errors">
                    {% for error in form.images.errors %}
                        <div class="form-error">{{ error }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        {% if form.non_field_errors %}
            <div class="form-errors">
                {% for error in form.non_field_errors %}
                    <div class="form-error">{{ error }}</div>
                {% endfor %}
            </div>
        {% endif %}

        <div class="form-actions">
            <button type="submit" class="btn btn--primary" id="upload-submit-btn">Upload Images</button>
            <a href="{% url 'calendars:calendar_detail' year=calendar.year %}" class="btn btn--outline">Cancel</a>
        </div>
    </form>
</div>

<div class="upload-tips">
    <h3>Bulk Upload Information</h3>
    <ul>
        <li>üìÅ Upload multiple images at once by selecting them all</li>
        <li>‚ö†Ô∏è <strong>Filename format is required:</strong> MMDD eventname.jpg</li>
        <li>‚ú® Images will be automatically resized to 320√ó200 pixels</li>
        <li>üîÑ If an event already exists for a date, the new image will replace it</li>
        <li>üíæ Supported formats: JPG, JPEG, PNG, GIF (up to 10MB each)</li>
    </ul>

    <div style="margin-top: 1rem; padding: 1rem; background: var(--color-bg-secondary); border-radius: var(--border-radius);">
        <strong>üí° Tip:</strong> For custom dates and cropping, use the
        <a href="{% url 'calendars:unified_photo_editor' %}?year={{ calendar.year }}">Upload & Edit Photo</a> feature instead.
    </div>
</div>

{% block extra_js %}
<script>
// Enhanced file upload feedback with size checking
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.querySelector('input[type="file"]');
    const submitBtn = document.getElementById('upload-submit-btn');

    if (fileInput && submitBtn) {
        fileInput.addEventListener('change', function(e) {
            const files = e.target.files;
            if (files.length > 0) {
                let totalSize = 0;
                let fileList = [];

                for (let i = 0; i < files.length; i++) {
                    totalSize += files[i].size;
                    fileList.push(`${files[i].name} (${formatFileSize(files[i].size)})`);
                }

                console.log(`Selected ${files.length} file(s) - Total: ${formatFileSize(totalSize)}`);

                // Show file info
                showFileInfo(files.length, totalSize, fileList);

                // Update button text for large uploads
                if (totalSize > 20 * 1024 * 1024) { // 20MB
                    submitBtn.textContent = `Upload ${files.length} Large File${files.length > 1 ? 's' : ''} (${formatFileSize(totalSize)})`;
                    submitBtn.title = 'Large files will show upload progress';
                } else {
                    submitBtn.textContent = `Upload ${files.length} File${files.length > 1 ? 's' : ''}`;
                    submitBtn.title = '';
                }
            } else {
                submitBtn.textContent = 'Upload Images';
                submitBtn.title = '';
                hideFileInfo();
            }
        });
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function showFileInfo(fileCount, totalSize, fileList) {
        // Remove existing info
        hideFileInfo();

        const form = document.querySelector('.form');
        const fileInfo = document.createElement('div');
        fileInfo.className = 'upload-file-preview';
        fileInfo.innerHTML = `
            <div class="file-preview-header">
                <strong>üìÅ ${fileCount} file${fileCount > 1 ? 's' : ''} selected</strong>
                <span class="file-preview-size">Total: ${formatFileSize(totalSize)}</span>
            </div>
            ${totalSize > 20 * 1024 * 1024 ?
                '<div class="file-preview-notice">‚è≥ Large files will show upload progress</div>' : ''
            }
        `;

        form.appendChild(fileInfo);
    }

    function hideFileInfo() {
        const existing = document.querySelector('.upload-file-preview');
        if (existing) {
            existing.remove();
        }
    }
});
</script>

<style>
.upload-file-preview {
    margin: 1rem 0;
    padding: 1rem;
    background: var(--color-bg-secondary);
    border-radius: var(--border-radius);
    border-left: 4px solid var(--primary-color);
}

.file-preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    color: var(--color-text-primary);
}

.file-preview-size {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9rem;
    color: var(--color-text-secondary);
}

.file-preview-notice {
    font-size: 0.85rem;
    color: var(--color-text-secondary);
    font-style: italic;
}

@media (max-width: 576px) {
    .file-preview-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
    }
}
</style>
{% endblock %}
{% endblock %}